name: PR CI — Tests & Cloudflare Build Check

# Runs on every PR targeting main.
# 1. Lints the codebase
# 2. Runs unit tests
# 3. Verifies the Cloudflare Pages build succeeds (without deploying)

on:
  pull_request:
    branches: ["main"]
    types: [opened, synchronize, reopened]

permissions:
  contents: read

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Dependencies
        run: npm install --legacy-peer-deps

      - name: Run ESLint
        run: npm run lint

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Dependencies
        run: npm install --legacy-peer-deps

      - name: Run Tests
        run: npm test
        continue-on-error: true

  cloudflare-build-check:
    name: Cloudflare Pages Build
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Dependencies
        run: npm install --legacy-peer-deps

      - name: Build for Cloudflare Pages (dry run)
        run: npm run cf-build
        env:
          NEXT_PUBLIC_BUILD_MODE: "true"
          NEXT_PUBLIC_URL: "https://groqtales.xyz"
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_GROQ_API_KEY: ${{ secrets.NEXT_PUBLIC_GROQ_API_KEY }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_WALLET_CONNECT_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_WALLET_CONNECT_PROJECT_ID }}
          NEXT_PUBLIC_IMAGE_URL: "https://groqtales.xyz/images"
          NEXT_PUBLIC_SPLASH_IMAGE_URL: "https://groqtales.xyz/splash.jpg"
          NEXT_PUBLIC_SPLASH_BACKGROUND_COLOR: "#1a1a2e"

      - name: Verify Build Output Exists
        run: |
          if [ -d "out" ]; then
            echo "✅ Build output directory exists"
            du -sh out
          else
            echo "❌ Build output directory not found!"
            exit 1
          fi
